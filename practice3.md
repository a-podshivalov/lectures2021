# Практическое занятие 2: процессы, межпроцессное взаимодействие, драйверы, интерфейсы внешних устройста

## Необходимая документация

Управление процессами в RIOT описано в документации ОС:

https://doc.riot-os.org/group__core.html

Для работы с внешними устройствами можно использовать имеющиеся в комплекте оборудования модули с датчиками освещенности OPT3001 (UMDK-LIT), температуры-влажности-давления BME280 (UMDK-THP), акселерометром/гироскопом LSM6DS3 (UMDK-ACC). Все они подключены по интерфейсу I2C, пример работы с этими датчиками выложен на Github (`examples-miem/sensors`). Описания драйверов устройств смотрите в каталоге RIOT, они приведены в соответствующих заголовочных файлах в формате Doxygen.

## Задания

1. (1) Продемонстрируйте в RIOT инверсию приоритетов (в том числе с участием "среднеприоритетного" процесса, не конкурирующего за ресурс) и взаимоблокировку потоков.

2. (1) Установите на "материнскую" плату UMDK-RF модули UMDK-LIT (датчик освещенности OPT3001) и UMDK-THP (датчик температуры-влажности-давления BME280). Проверьте работоспособность приложения `examples-miem/sensors`. Как видно из кода приложения, автор хотел производить измерения освещенности в 10 раз чаще, чем измерения состояния атмосферы - но на каждое измерение температуры приходится только 9 измерений освещенности. Почему и как это исправить?

3. (1) Подключите одновременно датчики температуры-влажности-давления BME280 и DHT11, сравните их показания.

4. (2) Подключите модуль ST95HF, реализуйте его опрос с использованием стандартного драйвера. +1 балл - за объединение кодового замка из предыдущего практического занятия с модулем чтения карт.

5. (2) Добавьте опрос нескольких датчиков, получение данных от них, управление GPIO и тому подобное - на ваш выбор - по протоколу Modbus RTU, используя штатный ("консольный") UART. Для проверки работы Modbus будет использоваться программа Termite: http://s2-team.ru/termite-quick-start-guide/

6. (2) Включите в приложение модуль shell (`sys/shell`), добавьте несколько команд для получения данных от датчиков.

7. (3) Используя рекомендации фирмы Maxim (https://www.maximintegrated.com/en/design/technical-documents/tutorials/2/214.html) и драйвер 1-wire (`drivers/onewire`), подключите к микроконтроллеру устройство с интерфейсом 1-Wire (например, "домофонный" ключ). Нужно использовать второй UART и дополнительную внешнюю "обвязку".

8. (3) Добавьте в драйвер I2C для STM32 обработку ошибок, восстановление после сбоев, и тому подобное.

9. (2-4) Добавьте драйвер любого внешнего устройства, которого еще нет в RIOT.

10. (4) Реализуйте простой планировщик с кооперативной многозадачностью для protothreads (http://www.dunkels.com/adam/pt/).

11. (4) Полезный примитив межпроцессного взаимодействия, более универсальный, чем mutex - это семафоры (описание есть в книгах Таненбаума и Столярова). В RIOT имеется реализация семафоров в "пользовательском" пространстве (`sys\sema`), во многих других операционных системах поддержка семафоров встроена на уровне ядра. Реализуйте семафоры в ядре RIOT, сравните требования и производительность обоих вариантов.

12. (5) Для предотвращения инверсии приоритетов иногда используется следующая методика: если приоритет какого-то из процессов, ожидающих освобождения ресурса (семафора, mutex'а, других средств синхронизации потоков), выше, чем приоритет процесса, занявшего этот ресурс - то приоритет последнего процесса поднимается до максимального из приоритетов потоков, ожидающих освобождения этого ресурса. Модифицируйте планировщик RIOT так, чтобы в нем реализовывалась такая стратегия назначения приоритетов. Будет ли при этом сложность планировщика независимой от количества процессов и mutex'ов?
